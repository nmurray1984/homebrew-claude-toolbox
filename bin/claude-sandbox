#!/usr/bin/env bash
# claude-sandbox - Run Claude Code inside an isolated OrbStack Docker container
# Only the current working directory is mounted; no other Mac files are accessible.

set -euo pipefail

WORK_DIR="$(pwd)"
IMAGE_NAME="claude-sandbox"
CONTAINER_NAME="claude-sandbox-$(date +%s)"

# â”€â”€ Build the image if it doesn't exist â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ! docker image inspect "$IMAGE_NAME" &>/dev/null; then
  echo "ðŸ”¨ Building Claude sandbox image (one-time setup)..."
  docker build --quiet -t "$IMAGE_NAME" - <<'DOCKERFILE'
FROM node:22-slim

RUN apt-get update && apt-get install -y --no-install-recommends \
      git curl ca-certificates && \
    rm -rf /var/lib/apt/lists/*

RUN npm install -g @anthropic-ai/claude-code

WORKDIR /workspace
ENTRYPOINT ["claude"]
DOCKERFILE
  echo "âœ… Image built."
fi

# â”€â”€ Validate ANTHROPIC_API_KEY is set â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ -z "${ANTHROPIC_API_KEY:-}" ]]; then
  echo "âŒ ANTHROPIC_API_KEY is not set. Export it in your shell or ~/.zshrc and try again."
  exit 1
fi

echo "ðŸš€ Launching Claude in sandbox..."
echo "   Working directory: $WORK_DIR"
echo "   (No other Mac files are accessible inside the container)"
echo ""

# â”€â”€ Run the container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# --rm           â†’ auto-remove container on exit
# -it            â†’ interactive TTY for Claude's UI
# -v             â†’ bind-mount only the current directory to /workspace
# --network=host â†’ allows Claude to reach the Anthropic API
# -e             â†’ pass in the API key
docker run --rm -it \
  --name "$CONTAINER_NAME" \
  -v "${WORK_DIR}:/workspace" \
  --network=host \
  -e ANTHROPIC_API_KEY \
  "$IMAGE_NAME" \
  "$@"
